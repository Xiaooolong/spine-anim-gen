# Spine 动画生成流程优化计划

用户对当前生成的 Spine 动画质量不满意（动作崩坏、无皮肤）。本计划旨在重构从视频到 Spine 的生成管线，引入动作平滑处理与自动蒙皮技术。

## 1. 动作优化 (解决 "是个啥玩意")
当前的动作崩坏主要源于关键点抖动和骨骼映射逻辑过于简单。
*   **引入平滑滤波**：在 Python 提取端增加**指数移动平均 (EMA)** 算法，平滑 MediaPipe 输出的原始关键点，减少画面抖动。
*   **优化坐标系转换**：修正 MediaPipe (Y-down) 到 Spine (Y-up) 的坐标变换逻辑，防止动作倒置或镜像错误。
*   **改进重定向 (Retargeting)**：重写 TS 端的骨骼角度计算，正确处理父子骨骼的相对旋转，确保肢体连接自然。

## 2. 自动蒙皮 (解决 "没皮肤")
将“火柴人”升级为“纸片人”，直接从视频中提取角色纹理。
*   **智能抠图**：利用 MediaPipe Pose 自带的 **Segmentation Mask** 功能，将视频中的人物从背景中分离。
*   **动态切片**：
    *   根据第一帧的骨骼位置，自动计算头部、躯干、四肢的 ROI (感兴趣区域)。
    *   利用 Mask 剔除背景，将各部位裁剪为独立的 PNG 图片（如 `head.png`, `body.png`, `arm_left.png` 等）。
*   **生成 Spine 皮肤**：
    *   **Setup Pose 构建**：以视频第一帧的姿态作为 Spine 骨架的初始绑定姿态 (Setup Pose)，确保图片与骨骼天然对齐。
    *   **Atlas 生成**：自动生成 `.atlas` 文件，描述切片图片的位置。
    *   **Skin/Slot 注入**：修改 Spine JSON 结构，增加 `slots` 和 `skins` 字段，将裁剪出的图片挂载到对应的骨骼上。

## 3. 执行步骤
1.  **修改 `poseExtractor.ts` (Python 脚本)**：
    *   开启 MediaPipe Segmentation。
    *   实现 EMA 平滑逻辑。
    *   实现“肢体切片器”，输出各部位 PNG 图片到任务目录。
2.  **重构 `retarget.ts` (Spine 生成)**：
    *   重写 `retargetPoseToSpine` 函数。
    *   读取切片图片信息，生成 Atlas。
    *   构建包含 Slot/Skin 的完整 Spine JSON。
    *   基于第一帧构建 Setup Pose，后续帧计算相对于第一帧的旋转差值。

## 预期结果
生成的 Spine 动画将不再是简单的线条，而是由视频中人物的“切片”拼装而成的角色，且动作更加流畅自然。虽然无法达到专业手绘的精细度，但能直观还原视频中的人物外观和动态。